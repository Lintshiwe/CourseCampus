rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Materials:
    // - Anyone can read.
    // - Authenticated users (admins) can create, update, and delete.
    // - Anyone can increment the download count.
    match /materials/{materialId} {
      allow read: if true;
      allow create, delete: if request.auth != null;
      
      // Admins can update any field
      allow update: if request.auth != null;
      
      // Anyone can update if they are ONLY incrementing the 'downloads' field
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['downloads'])
                    && request.resource.data.downloads == resource.data.downloads + 1;
    }

    // Feedback:
    // - Anyone can create.
    // - Authenticated users (admins) can read and delete.
    match /feedback/{feedbackId} {
      allow read, delete: if request.auth != null;
      allow create: if true;
    }

    // Bug Reports:
    // - Anyone can create.
    // - Authenticated users (admins) can read and delete.
    match /bug-reports/{reportId} {
      allow read, delete: if request.auth != null;
      allow create: if true;
    }

    // Social Links:
    // - Anyone can read.
    // - Authenticated users (admins) can create, update, and delete.
    match /social-links/{linkId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;
    }
  }
}
